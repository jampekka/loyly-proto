<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruuvi Bluetooth Web App</title>
</head>
<body>
    <h1>RuuviTag BLE Demo</h1>
    <button id="scan">Watch RuuviTag Advertisements / Notifications</button>
    <ul id="messages"></ul>
    <div style="margin:1em 0;">
        <label>Debug Temperature (째C): <input type="range" id="debug-temp" min="20" max="120" step="0.1" value="20"> <span id="debug-temp-val">20</span>째C</label>
        <br>
        <label>Debug RH (%): <input type="range" id="debug-rh" min="0" max="100" step="0.1" value="50"> <span id="debug-rh-val">50</span>%</label>
        <br>
        <button id="debug-apply">Apply Debug Values</button>
        <button id="debug-reset">Reset</button>
    </div>
    <script>
        // Ruuvi Data Format 5 decoder (binary, 24 bytes)
        function decodeRuuviDF5(dataView) {
            // DataView is expected to be 24 bytes, first byte is 0x05 (format)
            if (!(dataView instanceof DataView) || dataView.byteLength !== 24 || dataView.getUint8(0) !== 0x05) return null;
            try {
                // Temperature (0.005 degC)
                let tempRaw = dataView.getInt16(1, false);
                const temperature = tempRaw === -32768 ? null : +(tempRaw / 200.0);

                // Humidity (0.01%)
                const humidityRaw = dataView.getUint16(3, false);
                const humidity = humidityRaw === 0xFFFF ? null : +(humidityRaw / 400.0);

                // Pressure (Pa, +50000)
                const pressureRaw = dataView.getUint16(5, false);
                const pressure = pressureRaw === 0xFFFF ? null : +((pressureRaw + 50000) / 100.0);

                // Acceleration (mg)
                let accX = dataView.getInt16(7, false);
                let accY = dataView.getInt16(9, false);
                let accZ = dataView.getInt16(11, false);
                if (accX === -32768) accX = null;
                if (accY === -32768) accY = null;
                if (accZ === -32768) accZ = null;

                // Power info
                const powerInfo = dataView.getUint8(13);
                const batteryVoltage = powerInfo >> 5;
                const txPowerRaw = powerInfo & 0x1F;
                const battery = batteryVoltage === 0b1111111 ? null : 1600 + batteryVoltage;
                const txPower = txPowerRaw === 0b11111 ? null : -40 + (txPowerRaw * 2);

                // Movement counter
                const movement_counter = dataView.getUint8(15);

                // Measurement sequence number
                const measurement_sequence_number = dataView.getUint16(16, false);

                // MAC address (bytes 18-23, big endian)
                const mac = Array.from({length: 6}, (_, i) => dataView.getUint8(18 + i).toString(16).padStart(2, '0')).join(":");

                return {
                    humidity,
                    temperature,
                    pressure,
                    acceleration_x: accX,
                    acceleration_y: accY,
                    acceleration_z: accZ,
                    battery,
                    txPower,
                    movement_counter,
                    measurement_sequence_number,
                    mac
                };
            } catch (e) {
                return null;
            }
        }

        // Calculate Apparent Temperature (Steadman's formula, simplified)
        function apparentTemperature(T, RH) {
            if (T == null || RH == null) return null;
            const e = (RH / 100) * 6.105 * Math.exp(17.27 * T / (237.7 + T));
            const AT = T + 0.33 * e - 4.00;
            return AT;
        }

        let scanActive = false;
        let bleScan = null;

        let debugMode = false;
        let debugTemp = 20;
        let debugRH = 50;

        // Unified render function for sensor display
        function renderSensorDisplay({temperature, humidity, apparentTemperature, source}) {
            const messagesList = document.getElementById('messages');
            messagesList.innerHTML = '';
            let t = temperature !== null && temperature !== undefined ? temperature.toFixed(1) : '?';
            let rh = humidity !== null && humidity !== undefined ? humidity.toFixed(1) : '?';
            let at = apparentTemperature !== null && apparentTemperature !== undefined ? apparentTemperature.toFixed(1) : '?';
            messagesList.innerHTML =
                `<li style="font-size:2em;">T: <b>${t}째C</b> | AT: <b>${at}째C</b> | RH: <b>${rh}%</b>${source ? ` <span style='font-size:0.5em;color:#888;'>(${source})</span>` : ''}</li>`;
        }

        async function startLEScan() {
            const messagesList = document.getElementById('messages');
            messagesList.innerHTML = '';
            try {
                bleScan = await navigator.bluetooth.requestLEScan({
                    filters: [{namePrefix: "Ruuvi"}],
                });
                scanActive = true;
                const advItem = document.createElement('li');
                advItem.textContent = 'Scanning for advertisements... Move your RuuviTag nearby!';
                messagesList.appendChild(advItem);
                navigator.bluetooth.addEventListener('advertisementreceived', event => {
                    if (debugMode) return;
                    for (const [companyId, dataView] of event.manufacturerData) {
                        if (companyId === 0x0499 && dataView.byteLength == 24) {
                            const decoded = decodeRuuviDF5(dataView);
                            if (decoded) {
                                const at = apparentTemperature(decoded.temperature, decoded.humidity);
                                renderSensorDisplay({
                                    temperature: decoded.temperature,
                                    humidity: decoded.humidity,
                                    apparentTemperature: at,
                                    source: 'BLE'
                                });
                            }
                        }
                    }
                });
            } catch (error) {
                const errItem = document.createElement('li');
                errItem.textContent = 'Error: ' + error;
                messagesList.appendChild(errItem);
            }
        }

        function stopLEScan() {
            if (bleScan && scanActive) {
                bleScan.stop();
                scanActive = false;
                const messagesList = document.getElementById('messages');
                const stopItem = document.createElement('li');
                stopItem.textContent = 'Scan stopped.';
                messagesList.appendChild(stopItem);
            }
        }

        document.getElementById('scan').addEventListener('click', () => {
            if (!scanActive) {
                startLEScan();
                document.getElementById('scan').textContent = 'Stop Scan';
            } else {
                stopLEScan();
                document.getElementById('scan').textContent = 'Watch RuuviTag Advertisements / Notifications';
            }
        });

        // Update debug display values only (not the main sensor display)
        document.getElementById('debug-temp').addEventListener('input', e => {
            debugTemp = +e.target.value;
            document.getElementById('debug-temp-val').textContent = debugTemp;
        });

        document.getElementById('debug-rh').addEventListener('input', e => {
            debugRH = +e.target.value;
            document.getElementById('debug-rh-val').textContent = debugRH;
        });

        // Debug slider event now sends a fake BLE event to the render function
        document.getElementById('debug-apply').addEventListener('click', () => {
            debugMode = true;
            // Simulate a BLE event by calling the unified render function
            renderSensorDisplay({
                temperature: debugTemp,
                humidity: debugRH,
                apparentTemperature: apparentTemperature(debugTemp, debugRH),
                source: 'Debug'
            });
        });

        document.getElementById('debug-reset').addEventListener('click', () => {
            debugMode = false;
            document.getElementById('messages').innerHTML = '';
        });
    </script>
</body>
</html>